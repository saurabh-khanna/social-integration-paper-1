---
title: "Analysis for SN Paper 1"
author: "Saurabh Khanna"
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)
library(haven)
library(stargazer)

# Parameters
data_file <- here::here("data/stu_admin_all.Rds")
trends_file <- here::here("data/trends.csv")
```


Read main data file:

```{r}
df <-
  data_file %>%
  read_rds()
```



Relationship between transitivity/reciprocity and integration scores:

```{r}
df %>% 
  filter(elite == 0) %>% 
  ggplot() +
  geom_smooth(aes(b_reciprocity, b_seg_studymate), color = "red") +
  geom_smooth(aes(e_reciprocity, e_seg_studymate), color = "blue") +
  labs(
    x = "Reciprocity",
    y = "Segregation"
  )
```

Segregation gain across years:

```{r}
df %>% 
  select(classid, stdid, grade, elite, reservation, contains("_seg_stud")) %>% 
  filter(grade == 2) %>% 
  pivot_longer(
    cols = contains("_seg_"),
    names_to = "endline",
    values_to = "segregation"
  ) %>% 
  mutate(
    endline = recode(endline, "b_seg_studymate" = "0", "e_seg_studymate" = "1") %>% parse_integer(),
    reservation = recode(reservation, "Non-reservation" = "0", "Reservation" = "1") %>% parse_integer(),
    segregation = scale(segregation)
  ) %>%
  arrange(classid, stdid) %>% 
  filter(reservation == 0, elite == 0) %>% 
  lm(segregation ~ factor(endline), data = .) %>% 
  summary()

df %>% 
  select(classid, stdid, grade, elite, reservation, contains("_seg_stud")) %>% 
  filter(grade == 4) %>% 
  pivot_longer(
    cols = contains("_seg_"),
    names_to = "endline",
    values_to = "segregation"
  ) %>% 
  mutate(
    endline = recode(endline, "b_seg_studymate" = "0", "e_seg_studymate" = "1") %>% parse_integer(),
    reservation = recode(reservation, "Non-reservation" = "0", "Reservation" = "1") %>% parse_integer(),
    segregation = scale(segregation)
  ) %>%
  arrange(classid, stdid) %>% 
  filter(reservation == 0, elite == 0) %>% 
  lm(segregation ~ factor(endline), data = .) %>% 
  summary()
```



```{r}
trends_file %>% 
  read_csv() %>% 
  ggplot(aes(year, segregation, group = reservation, color = reservation)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_point(size = 2) +
  geom_line(size = 1) +
  facet_wrap(vars(elite)) +
  labs(
    x = "Year",
    y = "Relative Segregation"
  )
```

