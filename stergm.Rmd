---
title: "Analysis for SN Paper 1 - STERGMs"
author: "Saurabh Khanna"
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)
library(igraph)
library(ggraph)
library(tidygraph)
library(haven)
library(stargazer)
library(statnet)
library(intergraph)

# Parameters
baseline_network_file <- here::here("data/baseline_network.dta")
endline_network_file <- here::here("data/endline_network.dta")
stu_admin_all_file <- here::here("data/stu_admin_all_latest.dta")

#===============================================================================
```


## Creating networks for each classroom

```{r}
classids <- read_stata(endline_network_file) %>% select(classid) %>% arrange(classid) %>% distinct() %>% unlist()

b_netlist <- list()
e_netlist <- list()

for (class in classids) {
  print(str_c("Now at class: ", class))
  
  b_nodes <-
    read_stata(baseline_network_file) %>%
    filter(classid == class) %>%
    select(-b_node2) %>%
    mutate(
      reservation = recode(reservation, `Non-reservation` = "0", `Reservation` = "1", .default = NA_character_) %>% as.integer()
    ) %>% 
    distinct()

  b_edges <-
    read_stata(baseline_network_file) %>%
    filter(classid == class) %>%
    select(b_node1, b_node2) %>%
    filter(b_node2 != "")

  e_nodes <-
    read_stata(endline_network_file) %>%
    filter(classid == class) %>%
    select(-e_node2) %>%
    mutate(
      reservation = recode(reservation, `Non-reservation` = "0", `Reservation` = "1", .default = NA_character_) %>% as.integer()
    ) %>%
    distinct()

  e_edges <-
    read_stata(endline_network_file) %>%
    filter(classid == class) %>%
    select(e_node1, e_node2) %>%
    filter(e_node2 != "")
  
  b_netlist[[class]] <-
    graph_from_data_frame(b_edges, b_nodes, directed = TRUE) %>%
    asNetwork()
  
  e_netlist[[class]] <-
    graph_from_data_frame(e_edges, e_nodes, directed = TRUE) %>%
    asNetwork()
}
```

## Running STERGMs

```{r}
results <- tibble()

for (class in classids) {
  print(str_c("Now at class: ", class))
  
  model <- 
    stergm(
      list(b_netlist[[class]], e_netlist[[class]]),
      formation = 
        ~ edges + nodefactor("reservation") + nodematch("reservation") + mutual + gwesp(decay=.4, fixed=T),
      dissolution = 
        ~ edges + nodefactor("reservation") + nodematch("reservation") + mutual + gwesp(decay=.4, fixed=T),
      estimate = "CMLE",
      times = 1:2
    ) %>% 
    summary()
  
  results <-
    bind_rows(
      results,
      bind_cols(
        c(class, class, class, class, class) %>% as_tibble() %>% select(classid = value),
        tibble(name = c("edges", "nodefactor_res", "nodematch_res", "mutual", "gwesp")),
        model[["formation"]][["coefs"]][["Estimate"]] %>% as_tibble() %>% select(form_coef = value),
        model[["formation"]][["coefs"]][["Std. Error"]] %>% as_tibble() %>% select(form_se = value), 
        model[["dissolution"]][["coefs"]][["Estimate"]] %>% as_tibble() %>% select(diss_coef = value),
        model[["dissolution"]][["coefs"]][["Std. Error"]] %>% as_tibble() %>% select(diss_se = value)
      )
    )
}

results
```

